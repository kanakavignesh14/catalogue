pipeline {
    agent {
        node {
            label 'AGENT-1'
        }
    }

    environment {
        COURSE = "jenkins"
        appversion = ""
        ACCT_Id = "426130536166"
        PROJECT = "roboshop"
        COMPONENT = "catalogue"
    }

    options {
        //timeout(time: 10, unit: 'SECONDS')   // pipeline max runtime
        disableConcurrentBuilds()            // prevent parallel runs
    }

    stages {
        stage('Read version') {
            steps {
                script {
                    def packageJSON = readJSON file: 'package.json'
                    appversion = packageJSON.version

                    echo "package verion ${appversion}"
                        
                        
                   
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    sh """ 
                        npm install
                        
                    """    
                }
            }
        }

        stage('Unit Testing') {
            steps {
                script {
                    sh """ 
                        npm test
                        
                    """    
                }
            }
        }
        //Here you need to select scanner tool and send the analysis to server
       /* stage('Sonar Scan'){
            environment {
                def scannerHome = tool 'sonar-8.0'
            }
            steps {
                script{
                    withSonarQubeEnv('sonar-server') {
                        sh  "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }*/
        stage('Build image'){
            steps {
                script {
                    withAWS(region:'us-east-1',credentials:'aws-creds') {
                        sh """
                            
                            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${ACCT_Id}.dkr.ecr.us-east-1.amazonaws.com
                            docker build -t ${Acct_Id}.dkr.ecr.us-east-1.amazonaws.com/${PROJECT}/${COMPONENT}:${appversion} .

                            docker images

                            docker push ${Acct_Id}.dkr.ecr.us-east-1.amazonaws.com/${PROJECT}/${COMPONENT}:${appversion}
                        """
                            
                   }
                }
            }
        }

        stage('Deploy') {
            input {
                message "Should we continue?"
                ok "Yes, we should."
                submitter "alice,bob"
                parameters {
                    string(
                        name: 'PERSON',
                        defaultValue: 'Mr Jenkins',
                        description: 'Who should I say hello to?'
                    )
                }
            }
            steps {
                echo "Deploying"
                cleanWs()
            }
        }
    }

    post {
        always {
            echo "i will come always... HELLO WORLD"
        }
        success {
            echo "I will run if success"
        }
        failure {
            echo "I will run if failure"
        }
        aborted {
            echo "pipeline will be aborted"
        }
    }
}
